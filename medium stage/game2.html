<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Sliding Puzzle 3x4</title>
<style>
 body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  text-align: center;
  background: red;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 30px;
  height: 400px;
  justify-content: center;
  margin-bottom:0;
  padding-bottom:0;
margin-top:40px;
  }

  h1 {
    color: white;
    font-size: 2.5em;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
    margin-bottom: 10px;
  }

  #timer, #best-time {
    color: #fff;
    font-weight: bold;
    margin-bottom: 10px;
    font-size: 22px;
    background: rgba(255,255,255,0.2);
    padding: 4px 8px;
    border-radius: 8px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
  }

#game-container {
margin-top:20px;
  display: flex;
  align-items: center;
  width: 100%;
  height: 450px;
  padding: 12px 24px;
  border-radius: 12px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.2);
  background: rgba(255,255,255,0.2);
  margin-bottom:0;
  padding-bottom:0;
}

  #puzzle-container {
    position: relative;
    width: 600px;
    height: 400px;
    background: grey;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    margin-left: auto;
  }

  /* ‚úÖ disabled puzzle style */
  #puzzle-container.disabled {
    pointer-events: none;
    opacity: 0.4;
    filter: grayscale(80%);
  }

@media (orientation: landscape) {
  #game-container {
    transform: scale(0.685);
    transform-origin:top;
    width: 904px;
  }
  #puzzle-container {
    width: 600px;
    height: 400px;
  }
}

@media (orientation: portrait) {
  #game-container {
    margin-top: 50%;
    transform: scale(0.4);
    transform-origin:top;
    width: 904px;
  }
  #puzzle-container {
    width: 600px;
    height: 400px;
  }
}

#reference-image-container {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  margin-right: 20px;
  gap: 15px;
}

#reference-image {
  width: 280px;
  height: 210px;
  background-color: rgba(255, 255, 255, 0.7);
  background-size: cover;
  background-position: center;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
  margin-bottom: 10px;
  margin-top: 10px;
}

#reference-image-title {
  color: white;
  font-weight: bold;
  font-size: 1em;
  margin-bottom: 10px;
  margin-top: 20px;
}

  .tile {
    position: absolute;
    width: 150px;
    height: 133.33px;
    border-radius: 6px;
    transition: transform 0.3s ease;
    cursor: pointer;
    background-size: 600px 400px;
    background-repeat: no-repeat;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }

  .tile:hover {
    transform: scale(1.05);
    z-index: 10;
  }

  .empty {
    background: transparent;
    box-shadow: none;
    cursor: default;
  }

  #win-message {
    color: #000;
    font-weight: bold;
    margin-top: 20px;
    font-size: 20px;
    padding: 10px 20px;
    border-radius: 8px;
    display: none;
    animation: fadeIn 1s ease forwards;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
  }

  button {
    font-size: 40px;
    background: none;
    border: none;
    margin-bottom: 10px;
    margin-top: 10px;
  }

#tutorialPopup, #gameOverPopup {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  z-index: 999;
  background: #fff;
  color: #222;
  padding: 20px 22px;
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  text-align: center;
  max-width: 90%;
  width: 300px;
}

.hidden{ display:none !important; }

.popup h3 { margin-bottom:10px; margin-top:15px; color:#B9650B; font-size:1.8rem; font-weight:900; user-select:none; }
.popup p { font-size:1.1em; color:#333; }
.popup button { background:#CD923B; margin-top:15px; padding:12px 35px; font-size:1.2em; border-radius:12px; font-weight:bold; color:white; cursor:pointer; }

.overlay {  
  position: fixed;
  top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.6);
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  color:white; font-size:1.2em; padding:20px; text-align:center; z-index:400;
}
</style>
</head>
<body>

<div id="game-container">
  <div id="reference-image-container">
      <div id="best-time">Best Time: </div> 
    <div id="timer-container">
      <div id="timer">Time: 00:00:00</div>
      <div id="reference-image-title">Original photo :</div>
      <div id="reference-image"></div>
      <button id="retry" onclick="resetGame()">üîÑ</button>
      <div style="margin-bottom:10px;" class="retry-left" id="retryLeft"></div>
    </div>
  </div>
  <div id="puzzle-container"></div>
</div>

<div class="overlay" id="overlay"></div>

<div style="width:300px; padding:5px; height: 370px; gap:3px; line-height: 1;" class="popup" id="tutorialPopup">
  <h3>Tutorials</h3>
  <p>Welcome to <strong>Sliding Tiles üñºÔ∏è</strong>!</p>
  <p>1- Move the tiles until you complete the full photo.</p>
  <p>2- It's like the original sliding puzzle game.</p>
  <p><strong>üîÉ Rotate your phone for better experience</strong></p>
  <p>Good luck and have fun! üéâ</p>
  <button onclick="resetGame()">‚ñ∂Ô∏è Play</button>
</div>

<div id="gameOverPopup" class="popup hidden">
  <h2>üéâ Congratulations!</h2>
  <p id="endMessage"> You solved it in 00:00:00!</p>
  <p id="bestMessage">üèÜ Best Time: </p>
  <button onclick="resetGame()">Play Again</button>
  <div style="color: grey !important;" class="retry-left" id="retryLeft"></div>
</div>





<script>


const container = document.getElementById("puzzle-container");
const timerDisplay = document.getElementById("timer");

const rows = 3, cols = 4;
const tileWidth = 150, tileHeight = 133.33;
let tiles = [];
let emptyIndex = rows * cols - 1;
let timer = 0, interval;
let retries = 0;
const maxRetries = 3;

const images = [
  "2/1.png",
  "2/2.png",
  "2/3.png",
  "2/4.png"
];
let imageUrl;

let bestTime = null;

function updateBestTime(timeInSeconds) {
    if (timeInSeconds <= 0) return; // ignore invalid

    if (bestTime === null || timeInSeconds < bestTime) {
        bestTime = timeInSeconds;
        localStorage.setItem("game3HighScore", String(timeInSeconds)); // save correctly
    }

    document.getElementById('best-time').textContent =
        "Best Time: " + (bestTime === null ? "N/A" : formatTime(bestTime));
}



function formatTime(time) {
  const hours = Math.floor(time / 3600);
  const minutes = Math.floor((time % 3600) / 60);
  const seconds = time % 60;
  return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

function resetGame() {
  if (retries >= maxRetries) {
    alert("No retries left!");
    gameOverPopup.classList.add('hidden');
    document.getElementById('overlay').classList.add('hidden');
    disableGame();
    return;
  }

  gameOverPopup.classList.add('hidden');
document.getElementById('overlay').classList.add('hidden');

  // Start the game
  startGame();

  // Now consume a retry
  retries++;
  localStorage.setItem("farmRetries", retries);
  updateRetryLeft();
}

// ‚úÖ Reset Game (Retry buttons, consumes retry)
function resetGame() {
  if (retries >= maxRetries) {
    alert("No retries left!");
    document.getElementById('gameOverPopup').classList.add('hidden');
    disableGame(); // ‚úÖ disable game when retries are 0
    return;
  }
document.getElementById('gameOverPopup').classList.add('hidden');
  startGame();
  retries++;
  localStorage.setItem("game3Retries", retries); // ‚úÖ save retries
  updateRetryLeft();
  
}

const retryLeftEls = document.getElementsByClassName('retry-left');

function updateRetryLeft() {
  Array.from(retryLeftEls).forEach(el => {
    el.textContent = `Retries left: ${maxRetries-retries}/2`;
  });

  
}

// ‚úÖ disable game completely
// ‚úÖ disable game completely
function disableGame() {
  container.classList.add("disabled"); // disable puzzle only
  clearInterval(interval);

  // hide tutorial and overlay when retries are 0
  document.getElementById('tutorialPopup').classList.add('hidden');
  document.getElementById('overlay').classList.add('hidden');
}



// ‚úÖ start game
function startGame() {
  if (retries >= maxRetries) {
    disableGame();
    return;
  }

  document.getElementById('tutorialPopup').classList.add('hidden');
  document.getElementById('overlay').classList.add('hidden');
  clearInterval(interval);
  timer = 0;
  timerDisplay.textContent = "Time: 00:00:00";

  imageUrl = images[Math.floor(Math.random() * images.length)];
  document.getElementById("reference-image").style.backgroundImage = `url('${imageUrl}')`;
 
  tiles = [...Array(rows * cols).keys()];
  shuffleTiles();
  renderTiles();

  interval = setInterval(() => {
    timer++;
    timerDisplay.textContent = `Time: ${formatTime(timer)}`;
  }, 1000);
}

function shuffleTiles() {
  for (let i = tiles.length - 2; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [tiles[i], tiles[j]] = [tiles[j], tiles[i]];
  }
  emptyIndex = tiles.indexOf(rows * cols - 1);
}

function renderTiles() {
  container.innerHTML = "";
  tiles.forEach((tileNum, index) => {
    const r = Math.floor(index / cols);
    const c = index % cols;
    const div = document.createElement("div");
    div.className = "tile";
    div.style.transform = `translate(${c * tileWidth}px, ${r * tileHeight}px)`;

    if (tileNum === rows * cols - 1) {
      div.classList.add("empty");
    } else {
      const origRow = Math.floor(tileNum / cols);
      const origCol = tileNum % cols;
      div.style.backgroundImage = `url('${imageUrl}')`;
      div.style.backgroundPosition = `-${origCol * tileWidth}px -${origRow * tileHeight}px`;
      div.addEventListener("click", () => moveTile(index));
    }
    container.appendChild(div);
  });
}

function moveTile(index) {
  const emptyRow = Math.floor(emptyIndex / cols);
  const emptyCol = emptyIndex % cols;
  const tileRow = Math.floor(index / cols);
  const tileCol = index % cols;

  if ((Math.abs(tileRow - emptyRow) === 1 && tileCol === emptyCol) ||
      (Math.abs(tileCol - emptyCol) === 1 && tileRow === emptyRow)) {
    [tiles[emptyIndex], tiles[index]] = [tiles[index], tiles[emptyIndex]];
    emptyIndex = index;
    renderTiles();
    checkWin();
  }
}

function checkWin() {
  if (tiles.every((tile, i) => tile === i)) {
    clearInterval(interval);

    document.getElementById("endMessage").textContent =
      "üéâ You solved it in " + formatTime(timer) + "!";

    updateBestTime(timer);

    document.getElementById("bestMessage").textContent =
      "üèÜ Best Time: " + (bestTime === null ? "" : formatTime(bestTime));

    document.getElementById("gameOverPopup").classList.remove("hidden");
    document.getElementById("overlay").classList.remove("hidden");

    window.parent.postMessage({
      type: "highscore",
      game: 2,
      highscore: bestTime
    }, "*");

    return true;
  }
  return false;
}


// Load from localStorage on page load
window.onload = () => {
    document.getElementById("tutorialPopup").style.display = "block";

    const savedBest = localStorage.getItem("game3HighScore");

    if (savedBest !== null && !isNaN(savedBest)) {
        bestTime = Number(savedBest); // ‚úÖ load correctly
        document.getElementById('best-time').textContent = "Best Time: " + formatTime(bestTime);
    } else {
        bestTime = null;
        document.getElementById('best-time').textContent = "Best Time: N/A"; // ‚úÖ show N/A for new players
    }

    const savedRetries = localStorage.getItem("game3Retries");
    retries = savedRetries ? parseInt(savedRetries) : 0;
    updateRetryLeft();
};

</script>
</body>
</html>
