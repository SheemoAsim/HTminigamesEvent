<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>‚ö° Snap Match</title>
<style>
  * { box-sizing: border-box; font-family: 'Nunito', system-ui, Arial, sans-serif; }

  body {
    margin: 0;
    padding: 24px;
    min-height: 100vh;
    display: flex; flex-direction: column; align-items: center;
    background: transparent;
    color: #fff; text-align: center;
  }

  h1 { margin: 8px 0 12px; font-size: 2rem; text-shadow: 0 2px 6px rgba(0,0,0,0.2); }
  #hud { 
    display:flex;  
    gap:15px; font-size:1.1em; padding:0; 
    background:rgba(255,255,255,0.08); 
    border-radius:10px; width:350px; height: 30px; margin:0 ; 
    justify-content: center;
    align-items:center;
  }

  #gameContainer {
    margin-top:10px;
    width: 340px; height: 200px;
    display: flex; gap: 2px;
    border-radius: 14px; overflow: hidden; position: relative;
    box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(3px);
  }

  .half {
    width: 50%; height: 100%;
    display: grid; place-items: center;
    background: rgba(255,255,255,0.08);
    transition: background 0.2s ease;
  }
  .half.left { border-right: 2px dashed rgba(255,255,255,0.35); }
  .half.right { border-left: 2px dashed rgba(255,255,255,0.35); }

  .half img {
    max-width: 100px;
    max-height: 100px;
    object-fit: contain;
  }

  button { background:#6E0010; margin-top:25px; padding:12px 35px; font-size:1.2em; border-radius:12px; font-weight:bold; color:white; cursor:pointer; }

  #stopBtn {
    margin-top: 16px; padding: 12px 28px; font-weight: 800;
    border: 0; border-radius: 12px; cursor: pointer;
    background: #fff; color: #1c1c1c; box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    transition: transform .08s ease, background .2s ease;
  }
  button#stopBtn:active { transform: translateY(1px) scale(0.98); }
  button#stopBtn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  #overlay, #tutorialPopup {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.5);
    display: none; align-items: center; justify-content: center;
    z-index: 9999;
  }
  .popup {
    width: min(90vw, 340px);
    background: #fff; color: #333; border-radius: 14px;
    padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    text-align: center;
  }
  .popup h2 { margin: 0 0 8px; }
  .popup p { margin: 6px 0; }
  .note { color: #777; font-size: .95rem; margin-top: 8px; }
  img.tutorial-img { width: 100%; border-radius: 8px; margin-top: 8px; }
</style>
</head>
<body>

<h1>‚ö°Ô∏èHarvest Town Match</h1>
<div id="hud">
  üèÜ High Score: <span id="liveHighScore">0</span> |
  Score: <span id="score">0</span> |
  Lives: <span id="attempts">3</span> 
</div>

<div id="gameContainer" aria-live="polite">
  <div id="leftHalf" class="half left"></div>
  <div id="rightHalf" class="half right"></div>
</div>

<button id="stopBtn" onclick="stopMatch()">üõë Stop</button>

<button style="background: transparent; font-size: 1.2em; border: none; margin-top: 10px;" onclick="resetGame()">üîÑ</button>
<div class="retry-left"></div>

<div id="overlay">
  <div class="popup">
    <h2>üèÅ Game Over</h2>
    <p>‚úÖ Your Score: <span id="finalScore">0</span></p>
    <p>üèÜ High Score: <span id="highScore">0</span></p>
    <button onclick="resetGame()">Play Again</button>
    <div class="retry-left" style="color: grey !important;"></div>
  </div>
</div>

<div id="tutorialPopup">
  <div class="popup">
    <h3>Tutorials</h3>
    <p>Welcome to <strong>‚ö°Ô∏èHarvest Town Match</strong>!</p>
    <p>1- Icons will shuffle quickly on both sides.</p>
    <p>2- Press <strong>STOP</strong> when the two icons form a matching pair.<br>
       Example: üêÑ Cow & ü•õ Milk.</p>
    <p>3- Sometimes <strong style="color: #ff69b4;">Boby</strong> pair appears (<span style="color: #ff69b4;">Bonus round +10 points</span>).</p>
    <p>Good luck, and have fun! üéâ</p>
    <button onclick="resetGame()">‚ñ∂Ô∏è Play</button>
  </div>
</div>



<script>
let attempts = 3, score = 0;
let retries = 0;
const maxRetries = 2; // first play + 1 retry

let gameOver = false;
let speed = 400; 
let intervalId;
let feedbackTimeout;
let currentPair = null;
let previousPair = null;
let roundActive = false;

const leftEl = document.getElementById('leftHalf');
const rightEl = document.getElementById('rightHalf');
const attemptsEl = document.getElementById('attempts');
const scoreEl = document.getElementById('score');
const stopBtn = document.getElementById('stopBtn');
const overlay = document.getElementById('overlay');
const finalScoreEl = document.getElementById('finalScore');
const highScoreEl = document.getElementById('highScore');
const liveHighScoreEl = document.getElementById('liveHighScore');
const tutorialPopup = document.getElementById('tutorialPopup');
const gameContainer = document.getElementById('gameContainer');

const retryLeftEls = document.getElementsByClassName('retry-left');

window.onload = () => {
  const savedRetries = parseInt(localStorage.getItem("memoryRetries"));
  if (!isNaN(savedRetries)) retries = savedRetries;

  const savedHighScore = parseInt(localStorage.getItem("memoryHighScore")) || 0;
  highScoreEl.textContent = savedHighScore;
  liveHighScoreEl.textContent = savedHighScore;

  updateRetryLeft();

  if (retries >= maxRetries) {
    disableGame(); // ‚úÖ fully disable game if retries hit 0
  } else {
    showTutorial(); // only show tutorial if player can play
  }
};



function updateRetryLeft() {
    // total retries display = maxRetries - 1 (first play doesn't reduce display)
    let displayTotal = maxRetries - 1;

    // display retries: first play doesn't reduce display, but clamp to 0 minimum
    let displayRetries = Math.max(0, displayTotal - Math.max(0, retries - 1));

    // update all elements in retryLeftEls
    Array.from(retryLeftEls).forEach(el => {
        el.textContent = `Retries left: ${displayRetries}/${displayTotal}`;
    });

    // save current retries
    localStorage.setItem("memoryRetries", retries);
}




// Update high score display
function updateHighScore() {
  const best = parseInt(localStorage.getItem('memoryHighScore')) || 0;
  highScoreEl.textContent = best;
  liveHighScoreEl.textContent = best;
}

// Disable game when no retries left
function disableGame() {
  gameContainer.style.pointerEvents = "none";
  gameContainer.style.opacity = "1";


}

// Reset or retry the game
function resetGame() {
  if (retries >= maxRetries) {
    alert("No retries left!");
    overlay.style.display = 'none';
    disableGame();
    return;
  }
startGame()

  retries++;
  localStorage.setItem("memoryRetries", retries); // ‚úÖ Save immediately
  updateRetryLeft();
}

// Match pairs & bonus icons
const matchPairs = [
  "Small_Bomb.png:Super_Bomb.png",
  "Cherry.png:Cherry_pie.png",
  "Chicken2.png:Chicken_Adult2.png",
  "Jasmine.png:Jasmine_Tea2.png",
  "Cotton_Cloth.png:Cotton.png",
  "Milk2.png:Cow_Adult2.png",
  "Peach.png:Peach_Juice.png",
  "Duck_Adult2.png:Poultry_Feed_II2.png",
  "ErKetchup_Chip.png:Potato2.png",
  "Gold_Ore.png:Gold_Ingot2.png",
  "Peacock2.png:Peacock_Feather2.png"
];
const bonusIcons = ["bonus1.png"];
const allImages = matchPairs.flatMap(pair => pair.split(":"));


// ---------------- Preload all images ----------------
function preloadGameImages(callback) {
  let loadedCount = 0;
  function checkDone() {
    loadedCount++;
    if (loadedCount >= allImages.length) {
      console.log("‚úÖ Game 2 images preloaded!");
      window.parent.postMessage("loaded", "*"); // notify parent
      callback();
    }
  }

  allImages.forEach(src => {
    const img = new Image();
    img.src = src;
    if (img.complete) checkDone();
    else img.onload = img.onerror = checkDone;
  });
}



function randomIcon() {
  return allImages[Math.floor(Math.random() * allImages.length)];
}

function updateHUD() {
  attemptsEl.textContent = attempts;
  scoreEl.textContent = score;
  updateRetryLeft();
}

function startGame() {
  tutorialPopup.style.display = 'none';
  overlay.style.display = 'none';
  attempts = 3;
  score = 0;
  gameOver = false;
  stopBtn.disabled = true;
  updateHUD();
  startCycling();
}

function startCycling() {
  if (intervalId) clearInterval(intervalId);
  generateNextPair();
  intervalId = setInterval(generateNextPair, speed);
}

function generateNextPair() {
  previousPair = currentPair;
  if (Math.random() < 0.1) {
    const bonusImg = bonusIcons[Math.floor(Math.random() * bonusIcons.length)];
    leftEl.innerHTML  = `<img src="${bonusImg}" data-img="${bonusImg}">`;
    rightEl.innerHTML = `<img src="${bonusImg}" data-img="${bonusImg}">`;
    currentPair = { left: bonusImg, right: bonusImg, bonus: true };
  } else {
    const pairIndex = Math.floor(Math.random() * matchPairs.length);
    const pair = matchPairs[pairIndex].split(":");
    let leftImg = pair[0], rightImg;
    if (Math.random() < 0.3) {
      rightImg = pair[1];
    } else {
      do { rightImg = randomIcon(); } while (pair.includes(rightImg));
    }
    leftEl.innerHTML  = `<img src="${leftImg}" data-img="${leftImg}">`;
    rightEl.innerHTML = `<img src="${rightImg}" data-img="${rightImg}">`;
    currentPair = { left: leftImg, right: rightImg, bonus: false };
  }
  roundActive = true;
  stopBtn.disabled = false;
}

function stopMatch() {
  if (gameOver || !roundActive) return;
  clearInterval(intervalId);
  stopBtn.disabled = true;
  roundActive = false;
  clearTimeout(feedbackTimeout);
  const pairToEvaluate = previousPair || currentPair;
  const leftSrc  = pairToEvaluate.left;
  const rightSrc = pairToEvaluate.right;
  leftEl.innerHTML  = `<img src="${leftSrc}" data-img="${leftSrc}">`;
  rightEl.innerHTML = `<img src="${rightSrc}" data-img="${rightSrc}">`;

  const isBonus = !!(pairToEvaluate.bonus && leftSrc === rightSrc);
  let isMatch = false;
  if (!isBonus) {
    isMatch = matchPairs.some(pair => {
      const [a, b] = pair.split(":");
      return (leftSrc === a && rightSrc === b) || (leftSrc === b && rightSrc === a);
    });
  }

  if (isBonus) {
    leftEl.style.background = rightEl.style.background = "rgba(255,182,193,0.5)";
    score += 10;
  } else if (isMatch) {
    leftEl.style.background = rightEl.style.background = "rgba(0,255,0,0.3)";
    score++;
  } else {
    leftEl.style.background = rightEl.style.background = "rgba(255,0,0,0.3)";
    attempts--;
  }

  updateHUD();

  feedbackTimeout = setTimeout(() => {
    leftEl.style.background = rightEl.style.background = "rgba(255,255,255,0.08)";
    if (attempts <= 0) endGame();
    else startCycling();
  }, 500);
}

function endGame() {
  gameOver = true;
  stopBtn.disabled = true;
  finalScoreEl.textContent = score;

  let best = parseInt(localStorage.getItem('memoryHighScore') || '0', 10);
  if (score > best) {
    best = score;
    localStorage.setItem('memoryHighScore', score);
  }

  highScoreEl.textContent = best;
  liveHighScoreEl.textContent = best;

  // ‚úÖ Always send the stored best
  if (window.parent && window.parent !== window) {
    window.parent.postMessage({
      type: "highscore",
      game: "2",
      highscore: best
    }, "*");
  }

  updateRetryLeft();
  overlay.style.display = 'flex';
}



function showTutorial() {
  tutorialPopup.style.display = 'flex';
}

// On load
const savedHighScore = parseInt(localStorage.getItem("memoryHighScore")) || 0;
highScoreEl.textContent = savedHighScore;
liveHighScoreEl.textContent = savedHighScore;

// Update high score display
function updateHighScore() {
  const best = parseInt(localStorage.getItem('memoryHighScore')) || 0;
  highScoreEl.textContent = best;
  liveHighScoreEl.textContent = best;
}

</script>


</body>
</html>
