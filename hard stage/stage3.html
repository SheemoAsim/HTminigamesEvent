<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>HTMini Games - Stage-3 HARD</title>
<link href="style.css" rel="stylesheet">
<meta property="og:title" content="HTMini Games - Stage-3 HARD" />
  <meta property="og:description" content="click here for Stage-3 HARD" />
<meta property="og:image" content="https://sheemoasim.github.io/HTminigamesEvent/hard%20stage/header.png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />

  <meta property="og:url" content="https://sheemoasim.github.io/HTminigamesEvent/easy%20stage/stage1.html" />
  <meta property="og:type" content="website" />
</head>
<body>

<!-- Loading Screen -->
<div id="loading-screen">
  <div class="spinner"></div>
  <p id="loading-text">Loading... 0%</p>
</div>

<!-- Global Countdown -->
<div id="timer-overlay" style="left: 0; width: 100%; background-color: rgba(0, 0, 0, 0.5); color: white; padding: 5px; text-align: center; font-size: 12px; z-index: 1000; ">
  This stage will be closed down in <span id="endcountdown"></span>
</div>
<!-- PAGE 1 -->
<div style="padding: 20px;"class="page active" id="page1">
  <img src="HTMG.png" alt="Harvest Town Logo" class="logo" />
  <h2>3rd Stage</h2>
  <h3>HARD</h3>
  <input type="text" id="ign" placeholder="Enter IGN" />
  <input type="number" id="id" placeholder="Enter ID" />
  <button onclick="goToPage2()">Start</button>
  <div class="page-overlay hidden" id="pageOverlay1"></div>
</div>

<!-- PAGE 2 (Game 1 iframe) -->
<div class="page" id="page2">

  <iframe style="display: flex !important;background: transparent;"data-src="1/game1.html" class="game-frame"></iframe>
  <div class="bottom-buttons">
      <button onclick="goToPage(1)">â¬… Back</button>
      <button onclick="goToPage(3)">Next âž¡</button>
  </div>
</div>

<!-- PAGE 3 (Game 2 iframe) -->
<div class="page" id="page3">
    <iframe style="display: flex !important;height: 510px;"data-src="2/game2.html" class="game-frame"></iframe>
  <div class="bottom-buttons">
      <button onclick="goToPage(2)">â¬… Back</button>
      <button onclick="goToPage(4)">Next âž¡</button>
  </div>
</div>

<!-- PAGE 4 (Game 3 iframe) -->
<div class="page" id="page4">
<h1 style="text-align: center;">Spot The Target</h1>
  <iframe data-src="3/game3.html" class="game-frame"></iframe>
  <div class="bottom-buttons">
      <button onclick="goToPage(3)">â¬… Back</button>
  </div>
<button id="submit-button" class="submit-button" onclick="submitResults()">Submit</button>
<p class="reminder" id="reminder-text">
  Donâ€™t FORGET to submit your participation or youâ€™ll lose your progress
</p>
</div>

<!-- Submit -->


<script>

/* ---------- Global Countdown ---------- */
const deadline = new Date('2025-09-19T12:59:59');
window.onload = () => setInterval(countdown, 1000);

function countdown() {
    const currentTime = new Date();
    const timeRemaining = deadline - currentTime;
    const el = document.getElementById('endcountdown');
    if (!el) return;

    if (timeRemaining <= 0) {
        if (!window.stageEnded) {
            window.stageEnded = true;
            alert("Sorry, the time for this stage has ended. Better luck next time!");
            document.body.innerHTML = "";
            document.body.style.backgroundColor = "black";
        }
        return;
    }

    const days = Math.floor(timeRemaining / (1000*60*60*24));
    const hours = Math.floor((timeRemaining % (1000*60*60*24))/(1000*60*60));
    const minutes = Math.floor((timeRemaining % (1000*60*60))/(1000*60));
    const seconds = Math.floor((timeRemaining % (1000*60))/1000);
    el.textContent = `${days}D ${hours}Hr ${minutes}m ${seconds}s`;
}

/* ---------- Global Variables ---------- */
let scores = { 1: 0, 2: 0, 3: 0 };
let currentStage = 3;

/* ---------- Navigation ---------- */
function goToPage2(){
    const ign = document.getElementById('ign').value.trim();
    const id = document.getElementById('id').value.trim();
    if(!ign || !id){ alert("Please fill all fields"); return; }
    goToPage(2);
}

function goToPage(n){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    const pageEl = document.getElementById('page'+n);
    if(pageEl) pageEl.classList.add('active');
    scrollToTop();
}

function scrollToTop(){
    window.scrollTo({top:0,behavior:"smooth"});
}

/* ---------- Iframe Lazy Load ---------- */
const iframes = Array.from(document.querySelectorAll("iframe"));

function loadIframesAfterPreload() {
  iframes.forEach(iframe => {
    const src = iframe.getAttribute("data-src");
    if(src) iframe.src = src;
  });
}

/* ---------- Persistent Iframes Controller ---------- */
function persistAllIframes() {
  const iframes = document.querySelectorAll(".game-frame");
  iframes.forEach((iframe, index) => {
    const pageId = iframe.closest(".page")?.id || "unknown";
    const storageKey = `iframe_${pageId}_${index+1}`;

    const savedSrc = localStorage.getItem(storageKey);
    if (savedSrc) iframe.src = savedSrc;

    iframe.addEventListener("load", () => {
      try { localStorage.setItem(storageKey, iframe.src); } catch(e) {}
    });
    window.addEventListener("beforeunload", () => {
      try { localStorage.setItem(storageKey, iframe.src); } catch(e) {}
    });
  });
}
window.addEventListener("DOMContentLoaded", persistAllIframes);

/* ---------- Preload Iframe Game Assets ---------- */
function preloadIframeAssets() {
  const game1Items = [
    "Rose.png","Milk.png","Corn.png","Cherry.png","Gold_Necklace.png","Collar.png",
    "Meal_for_students.png","Ice_Cream.png","Yogurt.png","Peacock_Feather.png",
    "Rural_Dog.png","Sapphire.png","ErSilver_Bucket.png","Darkgold_Ore.png","Bike.png",
    "ErLimit_Pack.png","Cheese_Cake.png","ErKetchup_Chip.png","Small_Bomb.png",
    "Ginseng.png","Tuna_sandwich.png","Gold_Ingot.png",
  ];

  const matchPairs = [
    "Small_Bomb.png:Super_Bomb.png",
    "Cherry.png:Cherry_pie.png",
    "Chicken2.png:Chicken_Adult2.png",
    "Jasmine.png:Jasmine_Tea2.png",
    "Cotton_Cloth.png:Cotton.png",
    "Milk2.png:Cow_Adult2.png",
    "Peach.png:Peach_Juice.png",
    "Duck_Adult2.png:Poultry_Feed_II2.png",
    "ErKetchup_Chip.png:Potato2.png",
    "Gold_Ore.png:Gold_Ingot2.png",
    "Peacock2.png:Peacock_Feather2.png"
  ];
  const bonusIcons = ["bonus1.png"];
  const game2Items = matchPairs.flatMap(p => p.split(":")).concat(bonusIcons);

  const game3Items = [];
  for (let i = 0; i < 14; i++) {
    const start = (i * 3) + 1;
    game3Items.push(`${start}.png`, `${start+1}.png`, `${start+2}.png`);
  }

  const allImages = [...game1Items, ...game2Items, ...game3Items];

  const hiddenDiv = document.createElement("div");
  hiddenDiv.style.display = "none";
  document.body.appendChild(hiddenDiv);

  allImages.forEach(src => {
    const img = new Image();
    img.src = "assets/" + src;
    hiddenDiv.appendChild(img);
  });

  console.log("ðŸ“¦ Preloading", allImages.length, "iframe game assets...");
}
window.addEventListener("DOMContentLoaded", preloadIframeAssets);

/* ---------- Wait for All Images & Iframes (Dynamic) ---------- */
function waitForAllImagesDynamic(timeoutPerResource = 5000) {
  const loaderText = document.getElementById("loading-text");
  const iframes = Array.from(document.querySelectorAll("iframe"));
  const parentImages = Array.from(document.images);

  let resources = [...parentImages];
  let loadedCount = 0;

  const updateProgress = () => {
    loadedCount++;
    const percent = Math.min(Math.round((loadedCount / resources.length) * 100), 100);
    if (loaderText) loaderText.textContent = `Loading... ${percent}%`;
  };

  const trackImage = (img) => {
    if (!img) return;
    if (img.complete) {
      updateProgress();
    } else {
      img.addEventListener("load", updateProgress);
      img.addEventListener("error", updateProgress);
      setTimeout(updateProgress, timeoutPerResource);
    }
  };

  resources.forEach(trackImage);

  const observeNewImages = (root) => {
    const observer = new MutationObserver(mutations => {
      mutations.forEach(mutation => {
        mutation.addedNodes.forEach(node => {
          if (node.tagName === "IMG") {
            resources.push(node);
            trackImage(node);
          } else if (node.querySelectorAll) {
            node.querySelectorAll("img").forEach(img => {
              resources.push(img);
              trackImage(img);
            });
          }
        });
      });
    });
    observer.observe(root, { childList: true, subtree: true });
    return observer;
  };

  observeNewImages(document.body);

  iframes.forEach(iframe => {
    try {
      const doc = iframe.contentDocument || iframe.contentWindow.document;
      if (!doc) return;
      Array.from(doc.images).forEach(trackImage);
      observeNewImages(doc.body);
    } catch(e) {
      console.warn("Cannot access iframe (cross-origin):", iframe.src);
    }
  });

  return new Promise(resolve => {
    const checkInterval = setInterval(() => {
      if (loadedCount >= resources.length) {
        clearInterval(checkInterval);
        resolve();
      }
    }, 100);
  });
}

/* ---------- Hide Loader Once Everything Is Loaded ---------- */
window.addEventListener("load", () => {
  waitForAllImagesDynamic().then(() => {
    setTimeout(() => {
      const loader = document.getElementById("loading-screen");
      if (loader) {
        loader.style.transition = "opacity 0.5s ease";
        loader.style.opacity = "0";
        setTimeout(() => loader.remove(), 500);
      }
      document.body.style.overflow = "auto";
      loadIframesAfterPreload();
      console.log("âœ… All parent and iframe images (dynamic + preloaded) are fully loaded!");
    }, 500);
  });
});

document.body.style.overflow = "hidden";

/* ---------- Submit Results ---------- */
window.addEventListener("message", (event) => {
  if (event.data.type === "highscore") {
    scores[event.data.game] = event.data.highscore;
    console.log("Updated scores:", scores);
  }
});

function submitResults() {
  const confirmed = confirm("Are you sure you're done?");
  if (!confirmed) return;

  if (!navigator.onLine) {
    alert("Can't save result! Check your internet connection!");
    return;
  }

  const ign = document.getElementById('ign').value.trim();
  const id = document.getElementById('id').value.trim();

  alert(
    `IGN: ${ign}\nID: ${id}\nStage: ${currentStage}\n\n` +
    `G1: ${scores[1]}\n` +
    `G2: ${scores[2]}\n` +
    `G3: ${scores[3]}`
  );

  const submitBtn = document.getElementById("submit-button");
  submitBtn.classList.add("done");
  submitBtn.innerHTML = "Done!";
  submitBtn.disabled = true;

  const reminder = document.getElementById("reminder-text");
  reminder.innerHTML = `Thanks for participating, ${ign}! ðŸŽ‰<br><span id="ranking-link" style="color:#4dabf7; cursor:pointer;">See Leaderboard</span>`;
  reminder.style.color = "white";

  finishStage(currentStage, scores[1] || 0, scores[2] || 0, scores[3] || 0);

  setTimeout(() => {
    const rankingLink = document.getElementById("ranking-link");
    if (rankingLink) {
      rankingLink.addEventListener("click", () => {
        window.location.href = "HT minigames Results.html";
      });
    }
  }, 200);
}

function finishStage(stageNumber, g1, g2, g3) {
  const ign = document.getElementById("ign").value.trim();
  const id = document.getElementById("id").value.trim();

  let players = JSON.parse(localStorage.getItem("players")) || {};

  if (!players[ign]) {
    players[ign] = { ign, id, stages: {}, final:{} };
  }

  players[ign].stages[stageNumber] = { 
    raw:{ g1, g2, g3 }, 
    submittedAt: Date.now() 
  };

  localStorage.setItem("players", JSON.stringify(players));

  localStorage.setItem("latestStageResult", JSON.stringify({
    ign, id, stageNumber, g1, g2, g3
  }));

  console.log("âœ… Stage saved:", players[ign]);
}

/* ---------- Utility: Score Increment ---------- */
function addScore(gameNum, points){
    scores[gameNum] += points;
    const scoreEl = document.getElementById("score"+gameNum);
    if(scoreEl) scoreEl.textContent = scores[gameNum];
}

/* ---------- Initialize UI ---------- */
window.addEventListener("DOMContentLoaded", () => {
  const submitBtn = document.getElementById("submit-button");
  if (localStorage.getItem("enableSubmit") === "true") {
    submitBtn.disabled = false;
    submitBtn.classList.remove("done");
    submitBtn.innerHTML = "Submit";
    localStorage.removeItem("enableSubmit");
  }
});

</script>
</body>
</html>
